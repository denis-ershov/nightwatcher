#!/usr/bin/env bash

# –°–∫—Ä–∏–ø—Ç —É—Å—Ç–∞–Ω–æ–≤–∫–∏ systemd service –¥–ª—è NightWatcher
# –ó–∞–ø—É—Å—Ç–∏—Ç–µ: sudo bash install_service.sh

set -e

SERVICE_NAME="nightwatcher"
SERVICE_FILE="systemd-nightwatcher.service"
PROJECT_DIR="/home/nightwatcher"
SYSTEMD_DIR="/etc/systemd/system"

echo "============================================================"
echo "üåô –£—Å—Ç–∞–Ω–æ–≤–∫–∞ systemd service –¥–ª—è NightWatcher"
echo "============================================================"
echo ""

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫—Ä–∏–ø—Ç –∑–∞–ø—É—â–µ–Ω –æ—Ç root
if [ "$EUID" -ne 0 ]; then 
    echo "‚ùå –≠—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω —Å –ø—Ä–∞–≤–∞–º–∏ root (sudo)"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ —Ñ–∞–π–ª–∞ service
if [ ! -f "$SERVICE_FILE" ]; then
    echo "‚ùå –§–∞–π–ª $SERVICE_FILE –Ω–µ –Ω–∞–π–¥–µ–Ω!"
    echo "–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏–∏ –ø—Ä–æ–µ–∫—Ç–∞
if [ ! -d "$PROJECT_DIR" ]; then
    echo "‚ùå –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –ø—Ä–æ–µ–∫—Ç–∞ $PROJECT_DIR –Ω–µ –Ω–∞–π–¥–µ–Ω–∞!"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è
if [ ! -d "$PROJECT_DIR/venv" ]; then
    echo "‚ö†Ô∏è  –í–∏—Ä—Ç—É–∞–ª—å–Ω–æ–µ –æ–∫—Ä—É–∂–µ–Ω–∏–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –≤ $PROJECT_DIR/venv"
    echo "–°–æ–∑–¥–∞–π—Ç–µ –µ–≥–æ –∫–æ–º–∞–Ω–¥–æ–π: python3 -m venv venv"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ .env —Ñ–∞–π–ª–∞
if [ ! -f "$PROJECT_DIR/.env" ]; then
    echo "‚ö†Ô∏è  –§–∞–π–ª .env –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ $PROJECT_DIR"
    echo "–°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª .env —Å –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã–º–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–º–∏ –æ–∫—Ä—É–∂–µ–Ω–∏—è"
    exit 1
fi

# –ö–æ–ø–∏—Ä—É–µ–º service —Ñ–∞–π–ª
echo "üìã –ö–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ service —Ñ–∞–π–ª–∞..."
cp "$SERVICE_FILE" "$SYSTEMD_DIR/$SERVICE_NAME.service"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º systemd
echo "üîÑ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ systemd daemon..."
systemctl daemon-reload

# –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫
echo "‚úÖ –í–∫–ª—é—á–µ–Ω–∏–µ –∞–≤—Ç–æ–∑–∞–ø—É—Å–∫–∞..."
systemctl enable "$SERVICE_NAME.service"

echo ""
echo "============================================================"
echo "‚úÖ Service —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –∏ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!"
echo "============================================================"
echo ""
echo "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–µ—Ä–≤–∏—Å–æ–º:"
echo "  –ó–∞–ø—É—Å–∫:    sudo systemctl start $SERVICE_NAME"
echo "  –û—Å—Ç–∞–Ω–æ–≤–∫–∞: sudo systemctl stop $SERVICE_NAME"
echo "  –°—Ç–∞—Ç—É—Å:    sudo systemctl status $SERVICE_NAME"
echo "  –õ–æ–≥–∏:      sudo journalctl -u $SERVICE_NAME -f"
echo "  –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫: sudo systemctl restart $SERVICE_NAME"
echo ""
echo "–î–ª—è –∑–∞–ø—É—Å–∫–∞ —Å–µ–π—á–∞—Å –≤—ã–ø–æ–ª–Ω–∏—Ç–µ:"
echo "  sudo systemctl start $SERVICE_NAME"
echo ""
